# Настройка подписок через BotFather и ЮKassa

## Текущий статус: Тестовый режим

Сейчас бот работает в **тестовом режиме** (`TEST_MODE=True`). Все пользователи имеют доступ без подписки.

## Шаг 1: Настройка подписки в BotFather

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/mybots`
3. Выберите вашего бота из списка
4. Выберите **"Payments"** (Платежи)
5. Выберите **"Subscriptions"** (Подписки)
6. Нажмите **"Create Subscription"** (Создать подписку)
7. Заполните данные:
   - **Title** (Название): `Подписка на дневник вышивальщицы`
   - **Description** (Описание): `Ежемесячная подписка на доступ к боту`
   - **Price** (Цена): укажите цену (например, `99` для 99₽)
   - **Period** (Период): `1 month` (1 месяц)
8. BotFather выдаст вам **Subscription ID** (например, `subscription_1234567890`)

## Шаг 2: Настройка ЮKassa (если требуется)

Telegram Payments использует встроенную систему платежей. Для работы подписок через BotFather обычно не требуется отдельная настройка ЮKassa, так как Telegram обрабатывает платежи самостоятельно.

Однако, если вы хотите использовать ЮKassa напрямую:

1. Зарегистрируйтесь на [yookassa.ru](https://yookassa.ru)
2. Создайте магазин
3. Получите **Shop ID** и **Secret Key**
4. В BotFather настройте платежи:
   - `/mybots` → выберите бота → **Payments** → **Payment Provider**
   - Выберите **YooKassa** и введите данные

## Шаг 3: Обновление .env файла

После получения Subscription ID обновите файл `.env`:

```env
BOT_TOKEN=ваш_токен_от_BotFather
DATA_DIR=./data
TEST_MODE=False
SUBSCRIPTION_ID=subscription_1234567890
```

**Важно:** 
- `TEST_MODE=False` - отключает тестовый режим, теперь будет проверяться подписка
- `SUBSCRIPTION_ID` - ID подписки из BotFather

## Шаг 4: Включение подписок в коде

После настройки подписки в BotFather нужно будет добавить отправку инвойса в функции `callback_subscribe` в файле `handlers/subscriptions.py`.

Пример кода для отправки инвойса:

```python
from aiogram.types import LabeledPrice

# В функции callback_subscribe:
await bot.send_invoice(
    chat_id=callback.from_user.id,
    title="Подписка на дневник вышивальщицы",
    description="Ежемесячная подписка на доступ к боту",
    payload=f"subscription_{callback.from_user.id}",
    provider_token="",  # Для Telegram Payments оставляем пустым
    currency="RUB",
    prices=[LabeledPrice(label="Подписка на 1 месяц", amount=9900)],  # 99₽ = 9900 копеек
    start_parameter=SUBSCRIPTION_ID,
    is_flexible=False
)
```

## Шаг 5: Тестирование

1. Установите `TEST_MODE=False` в `.env`
2. Перезапустите бота
3. Отправьте `/start` боту
4. Нажмите "Оформить подписку"
5. Проверьте, что инвойс отправляется корректно

## Обработка событий подписки

Telegram автоматически обрабатывает:
- **Успешную оплату** - обрабатывается в `process_subscription_payment`
- **Отмену подписки** - можно обработать через webhook (требует настройки сервера)

## Webhook для подписок (опционально)

Для полноценной обработки событий подписок (обновление, отмена) нужно настроить webhook:

1. Настройте HTTPS сервер
2. Зарегистрируйте webhook в BotFather
3. Обрабатывайте события `subscription_created`, `subscription_cancelled`, `subscription_renewed`

## Важные замечания

- В тестовом режиме (`TEST_MODE=True`) все пользователи имеют доступ
- После отключения тестового режима пользователи без подписки не смогут использовать бот
- Подписка автоматически продлевается Telegram (если настроено)
- Срок действия подписки сохраняется в `data/subscriptions.json`


