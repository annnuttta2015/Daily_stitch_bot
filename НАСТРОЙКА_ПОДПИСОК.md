# Настройка подписок через BotFather и ЮKassa

## Текущий статус: Тестовый режим

Сейчас бот работает в **тестовом режиме** (`TEST_MODE=True`). Все пользователи имеют доступ без подписки.

## Шаг 1: Настройка платежей в BotFather

**Важно:** В BotFather нет отдельного раздела для создания подписок. Подписки работают через обычные инвойсы (счета на оплату).

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/mybots`
3. Выберите вашего бота из списка
4. Выберите **"Payments"** (Платежи)
5. Выберите **"Payment Provider"** (Провайдер платежей)
6. Выберите **"YooKassa"** (ЮKassa)
7. Введите данные от ЮKassa:
   - **Shop ID** - ID магазина из личного кабинета ЮKassa
   - **Secret Key** - секретный ключ из личного кабинета ЮKassa

## Шаг 2: Настройка ЮKassa

1. Зарегистрируйтесь на [yookassa.ru](https://yookassa.ru)
2. Создайте магазин (если еще не создан)
3. Перейдите в раздел **"Настройки"** → **"API"**
4. Получите:
   - **Shop ID** (ID магазина) - находится в разделе "Настройки"
   - **Secret Key** (Секретный ключ) - создайте в разделе "API ключи"
5. Скопируйте эти данные и введите их в BotFather (см. Шаг 1)

## Шаг 3: Обновление .env файла

Обновите файл `.env`:

```env
BOT_TOKEN=ваш_токен_от_BotFather
DATA_DIR=./data
TEST_MODE=False
SUBSCRIPTION_ID=  # Можно оставить пустым, не обязателен
ADMIN_IDS=ваш_telegram_id
```

**Важно:** 
- `TEST_MODE=False` - отключает тестовый режим, теперь будет проверяться подписка
- `SUBSCRIPTION_ID` - не обязателен, можно оставить пустым
- `ADMIN_IDS` - ваш Telegram ID для доступа к команде `/users`

## Шаг 4: Включение подписок в коде

После настройки подписки в BotFather нужно будет добавить отправку инвойса в функции `callback_subscribe` в файле `handlers/subscriptions.py`.

Пример кода для отправки инвойса:

```python
from aiogram.types import LabeledPrice

# В функции callback_subscribe:
await bot.send_invoice(
    chat_id=callback.from_user.id,
    title="Подписка на дневник вышивальщицы",
    description="Ежемесячная подписка на доступ к боту",
    payload=f"subscription_{callback.from_user.id}",
    provider_token="",  # Для Telegram Payments оставляем пустым
    currency="RUB",
    prices=[LabeledPrice(label="Подписка на 1 месяц", amount=9900)],  # 99₽ = 9900 копеек
    start_parameter=SUBSCRIPTION_ID,
    is_flexible=False
)
```

## Шаг 5: Тестирование

1. Установите `TEST_MODE=False` в `.env`
2. Перезапустите бота
3. Отправьте `/start` боту
4. Нажмите "Оформить подписку"
5. Проверьте, что инвойс отправляется корректно

## Обработка событий подписки

Telegram автоматически обрабатывает:
- **Успешную оплату** - обрабатывается в `process_subscription_payment`
- **Отмену подписки** - можно обработать через webhook (требует настройки сервера)

## Webhook для подписок (опционально)

Для полноценной обработки событий подписок (обновление, отмена) нужно настроить webhook:

1. Настройте HTTPS сервер
2. Зарегистрируйте webhook в BotFather
3. Обрабатывайте события `subscription_created`, `subscription_cancelled`, `subscription_renewed`

## Важные замечания

- В тестовом режиме (`TEST_MODE=True`) все пользователи имеют доступ
- После отключения тестового режима пользователи без подписки не смогут использовать бот
- Подписка автоматически продлевается Telegram (если настроено)
- Срок действия подписки сохраняется в `data/subscriptions.json`


